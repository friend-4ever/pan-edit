<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dream Tech - Final Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <style>
        /* Pure Black Theme */
        body { background-color: #000000; color: #e5e5e5; font-family: 'Segoe UI', sans-serif; }
        .card { background-color: #111111; border: 1px solid #333; border-radius: 8px; position: relative; }
        .btn-primary { background-color: #2563eb; color: white; transition: 0.3s; }
        .btn-primary:hover { background-color: #1d4ed8; box-shadow: 0 0 15px rgba(37, 99, 235, 0.5); }
        .btn-purple { background-color: #9333ea; color: white; transition: 0.3s; }
        .btn-purple:hover { background-color: #7e22ce; box-shadow: 0 0 15px rgba(147, 51, 234, 0.5); }
        
        /* Drag and Drop Zone Styles */
        .drop-zone { border: 2px dashed #444; transition: 0.2s; background: #0a0a0a; }
        .drop-zone.dragover { border-color: #2563eb; background: #1e1e1e; }
        
        /* Cropper Customization */
        .cropper-view-box, .cropper-face { outline-color: #2563eb; }
        .cropper-line, .cropper-point { background-color: #2563eb; }
        .cropper-modal { background-color: #000; opacity: 0.8; }
        
        /* Loader */
        .spinner { border: 3px solid rgba(255,255,255,0.1); border-radius: 50%; border-top: 3px solid #fff; width: 18px; height: 18px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-left: 8px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto space-y-8">
        
        <div class="flex justify-between items-center border-b border-gray-800 pb-4">
            <div>
                <h1 class="text-3xl font-bold text-white tracking-wider">DREAM <span class="text-blue-600">TECH</span></h1>
            </div>
            <div class="text-xs font-mono text-green-500 border border-green-900 bg-green-900/20 px-3 py-1 rounded">
                SYSTEM: ONLINE
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <button onclick="switchMode('nsdl')" id="nav-nsdl" class="py-3 bg-blue-600 text-white font-bold rounded border border-blue-500">
                1. PAN Correction (NSDL)
            </button>
            <button onclick="switchMode('uti')" id="nav-uti" class="py-3 bg-gray-900 text-gray-400 font-bold rounded border border-gray-800 hover:bg-gray-800">
                2. Smart UTI 3.0
            </button>
        </div>

        <div id="panel-nsdl" class="space-y-6">
            
            <div class="grid md:grid-cols-2 gap-6">
                <div class="card p-5">
                    <div class="absolute top-0 right-0 bg-blue-900/40 text-blue-300 text-xs font-mono px-2 py-1 rounded-bl border-l border-b border-blue-900">
                        2.5x3.5cm | 50 KB
                    </div>
                    <h3 class="text-lg font-bold text-gray-200 mb-4">üë§ Photo Crop</h3>
                    
                    <div class="drop-zone rounded p-4 text-center cursor-pointer mb-4 relative" id="drop-nsdl-photo">
                        <p class="text-gray-500 text-sm pointer-events-none">Drag & Drop or Click</p>
                        <input type="file" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer w-full h-full" onchange="initCropper(this, 2.5/3.5, 'nsdl-photo')">
                    </div>
                    
                    <div id="wrap-nsdl-photo" class="hidden">
                        <div class="h-64 bg-black border border-gray-700 overflow-hidden relative">
                            <img id="img-nsdl-photo" class="max-w-full">
                        </div>
                        <button id="btn-nsdl-photo" onclick="downloadStrict('nsdl-photo', 295, 413, false)" class="w-full mt-4 btn-primary py-2 rounded font-bold uppercase text-sm">
                            Download <span class="spinner hidden"></span>
                        </button>
                    </div>
                </div>

                <div class="card p-5">
                    <div class="absolute top-0 right-0 bg-blue-900/40 text-blue-300 text-xs font-mono px-2 py-1 rounded-bl border-l border-b border-blue-900">
                        4.5x2.0cm | 50 KB
                    </div>
                    <h3 class="text-lg font-bold text-gray-200 mb-4">‚úçÔ∏è Signature Crop</h3>
                    
                    <div class="drop-zone rounded p-4 text-center cursor-pointer mb-4 relative" id="drop-nsdl-sig">
                        <p class="text-gray-500 text-sm pointer-events-none">Drag & Drop or Click</p>
                        <input type="file" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer w-full h-full" onchange="initCropper(this, 4.5/2.0, 'nsdl-sig')">
                    </div>
                    
                    <div id="wrap-nsdl-sig" class="hidden">
                        <div class="h-64 bg-black border border-gray-700 overflow-hidden relative">
                            <img id="img-nsdl-sig" class="max-w-full">
                        </div>
                        <button id="btn-nsdl-sig" onclick="downloadStrict('nsdl-sig', 531, 236, true)" class="w-full mt-4 btn-primary py-2 rounded font-bold uppercase text-sm">
                            Download <span class="spinner hidden"></span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="card p-6 border-red-900/30">
                <div class="absolute top-0 right-0 bg-red-900/40 text-red-300 text-xs font-mono px-2 py-1 rounded-bl border-l border-b border-red-900">
                    300 KB
                </div>
                <div class="flex items-center gap-3 mb-2">
                    <h3 class="text-xl font-bold text-red-500">üìÑ PDF Compressor</h3>
                </div>
                <p class="text-gray-500 text-sm mb-4">Upload PDF, JPG, or PNG</p>

                <div class="drop-zone rounded p-6 flex flex-col items-center justify-center text-center relative" id="drop-pdf">
                    <input type="file" id="pdf-file" accept=".pdf, image/png, image/jpeg, image/jpg" class="absolute inset-0 opacity-0 cursor-pointer w-full h-full" onchange="handleFileSelect()">
                    <p class="text-gray-400 font-bold">Click or Drag (PDF / JPG / PNG)</p>
                    <p id="pdf-name" class="text-sm text-gray-600 mt-1">No file selected</p>
                </div>

                <button id="btn-pdf" onclick="processUnifiedPDF()" class="w-full mt-4 bg-red-600 hover:bg-red-700 text-white px-8 py-3 rounded font-bold flex items-center justify-center gap-2">
                    Download PDF <span id="spinner-pdf" class="spinner hidden"></span>
                </button>
                <div id="pdf-msg" class="mt-3 text-center text-xs font-mono text-gray-500"></div>
            </div>

        </div>

        <div id="panel-uti" class="hidden space-y-6">
            <div class="grid md:grid-cols-2 gap-6">
                
                <div class="card p-5 border-purple-900/30">
                    <div class="absolute top-0 right-0 bg-purple-900/40 text-purple-300 text-xs font-mono px-2 py-1 rounded-bl border-l border-b border-purple-900">
                        213x213px | 50 KB
                    </div>
                    <h3 class="text-lg font-bold text-purple-400 mb-4">üë§ Photo Crop</h3>
                    
                    <div class="drop-zone rounded p-4 text-center cursor-pointer mb-4 relative" id="drop-uti-photo">
                        <p class="text-gray-500 text-sm pointer-events-none">Drag & Drop or Click</p>
                        <input type="file" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer w-full h-full" onchange="initCropper(this, 1, 'uti-photo')">
                    </div>

                    <div id="wrap-uti-photo" class="hidden">
                        <div class="h-64 bg-black overflow-hidden"><img id="img-uti-photo"></div>
                        <button id="btn-uti-photo" onclick="downloadStrict('uti-photo', 213, 213, false)" class="w-full mt-4 btn-purple py-2 rounded font-bold uppercase text-sm">
                            Download <span class="spinner hidden"></span>
                        </button>
                    </div>
                </div>

                <div class="card p-5 border-purple-900/30">
                    <div class="absolute top-0 right-0 bg-purple-900/40 text-purple-300 text-xs font-mono px-2 py-1 rounded-bl border-l border-b border-purple-900">
                        400x200px | 50 KB
                    </div>
                    <h3 class="text-lg font-bold text-purple-400 mb-4">‚úçÔ∏è Signature Crop</h3>
                    
                    <div class="drop-zone rounded p-4 text-center cursor-pointer mb-4 relative" id="drop-uti-sig">
                        <p class="text-gray-500 text-sm pointer-events-none">Drag & Drop or Click</p>
                        <input type="file" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer w-full h-full" onchange="initCropper(this, 2/1, 'uti-sig')">
                    </div>

                    <div id="wrap-uti-sig" class="hidden">
                        <div class="h-64 bg-black overflow-hidden"><img id="img-uti-sig"></div>
                        <button id="btn-uti-sig" onclick="downloadStrict('uti-sig', 400, 200, true)" class="w-full mt-4 btn-purple py-2 rounded font-bold uppercase text-sm">
                            Download <span class="spinner hidden"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        const croppers = {};

        // --- 1. UI LOGIC ---
        function switchMode(mode) {
            document.getElementById('panel-nsdl').classList.add('hidden');
            document.getElementById('panel-uti').classList.add('hidden');
            document.getElementById('panel-' + mode).classList.remove('hidden');

            const btnNsdl = document.getElementById('nav-nsdl');
            const btnUti = document.getElementById('nav-uti');
            
            if (mode === 'nsdl') {
                btnNsdl.className = "py-3 bg-blue-600 text-white font-bold rounded border border-blue-500 shadow-[0_0_15px_rgba(37,99,235,0.4)]";
                btnUti.className = "py-3 bg-gray-900 text-gray-400 font-bold rounded border border-gray-800 hover:bg-gray-800";
            } else {
                btnUti.className = "py-3 bg-purple-600 text-white font-bold rounded border border-purple-500 shadow-[0_0_15px_rgba(147,51,234,0.4)]";
                btnNsdl.className = "py-3 bg-gray-900 text-gray-400 font-bold rounded border border-gray-800 hover:bg-gray-800";
            }
        }

        ['drop-nsdl-photo', 'drop-nsdl-sig', 'drop-uti-photo', 'drop-uti-sig', 'drop-pdf'].forEach(id => {
            const el = document.getElementById(id);
            el.addEventListener('dragover', (e) => { e.preventDefault(); el.classList.add('dragover'); });
            el.addEventListener('dragleave', () => el.classList.remove('dragover'));
            el.addEventListener('drop', (e) => {
                e.preventDefault(); el.classList.remove('dragover');
                const input = el.querySelector('input');
                if (e.dataTransfer.files.length) {
                    input.files = e.dataTransfer.files;
                    const event = new Event('change');
                    input.dispatchEvent(event);
                }
            });
        });

        function handleFileSelect() {
            const input = document.getElementById('pdf-file');
            const nameDisplay = document.getElementById('pdf-name');
            if (input.files[0]) {
                nameDisplay.textContent = input.files[0].name;
                nameDisplay.classList.add('text-white');
            }
        }

        // --- 2. CROPPER LOGIC (Fixed White Border) ---
        function initCropper(input, ratio, id) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    if (croppers[id]) croppers[id].destroy();
                    const img = document.getElementById('img-' + id);
                    img.src = e.target.result;
                    document.getElementById('wrap-' + id).classList.remove('hidden');
                    croppers[id] = new Cropper(img, {
                        aspectRatio: ratio, 
                        viewMode: 1, 
                        dragMode: 'move', 
                        autoCropArea: 0.9, 
                        background: false, 
                        guides: true,
                    });
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- 3. STRICT 49KB IMAGE LOGIC (Backend remains STRICT) ---
        async function downloadStrict(id, baseWidth, baseHeight, isSignature) {
            if (!croppers[id]) return;

            const btn = document.getElementById('btn-' + id);
            const spinner = btn.querySelector('.spinner');
            btn.disabled = true;
            spinner.classList.remove('hidden');

            const cropOpts = {
                width: baseWidth, 
                height: baseHeight, 
                imageSmoothingEnabled: true, 
                imageSmoothingQuality: 'high'
            };
            
            // Only add white background if it's a signature
            if (isSignature) {
                cropOpts.fillColor = '#fff';
            }

            const getBlob = (w, h, q) => {
                return new Promise(resolve => {
                    cropOpts.width = w;
                    cropOpts.height = h;
                    const canvas = croppers[id].getCroppedCanvas(cropOpts);
                    canvas.toBlob(blob => resolve(blob), 'image/jpeg', q);
                });
            };

            try {
                // LOCK: 48KB - 49KB (Safe Zone below 50KB)
                const minBytes = 48 * 1024; 
                const maxBytes = 49 * 1024;
                
                let scale = 1.0;
                let quality = 0.95;
                let blob = null;

                // Heavy upscale start
                scale = 3.0; 
                
                let attempts = 0;
                while (attempts < 30) {
                    blob = await getBlob(baseWidth * scale, baseHeight * scale, quality);
                    
                    if (blob.size >= minBytes && blob.size <= maxBytes) {
                        break; 
                    }

                    if (blob.size > maxBytes) {
                        if (quality > 0.1) quality -= 0.02;
                        else scale -= 0.1;
                    } else {
                        if (quality < 1.0) quality += 0.02;
                        else scale += 0.2;
                    }

                    if (scale < 0.5) scale = 0.5;
                    if (scale > 10) scale = 10;
                    if (quality < 0.05) quality = 0.05;
                    if (quality > 1.0) quality = 1.0;

                    attempts++;
                }

                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `${id}_Strict.jpg`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

            } catch (err) {
                console.error(err);
            } finally {
                btn.disabled = false;
                spinner.classList.add('hidden');
            }
        }

        // --- 4. STRICT 298KB PDF LOCK (Backend remains STRICT) ---
        async function processUnifiedPDF() {
            const fileInput = document.getElementById('pdf-file');
            const status = document.getElementById('pdf-msg');
            const spinner = document.getElementById('spinner-pdf');
            const btn = document.getElementById('btn-pdf');

            if (!fileInput.files[0]) {
                status.innerText = "Please select a file first.";
                status.className = "mt-3 text-center text-xs font-mono text-red-500";
                return;
            }

            btn.disabled = true;
            spinner.classList.remove('hidden');
            status.innerText = "Compressing...";
            status.className = "mt-3 text-center text-xs font-mono text-blue-400";

            try {
                const file = fileInput.files[0];
                const { jsPDF } = window.jspdf;
                
                const generatePdfBlob = async (targetScale, jpgQuality) => {
                    const newPdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4', compress: true });
                    const pageWidth = 210;
                    const pageHeight = 297;

                    if (file.type === 'application/pdf') {
                        const arrayBuffer = await file.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                        
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            let viewport = page.getViewport({ scale: 1.0 });
                            const finalScale = (1240 * targetScale) / viewport.width;
                            viewport = page.getViewport({ scale: finalScale });

                            const canvas = document.createElement('canvas');
                            canvas.width = viewport.width;
                            canvas.height = viewport.height;
                            const ctx = canvas.getContext('2d');
                            await page.render({ canvasContext: ctx, viewport: viewport }).promise;
                            
                            const imgData = canvas.toDataURL('image/jpeg', jpgQuality);
                            if (i > 1) newPdf.addPage();
                            newPdf.addImage(imgData, 'JPEG', 0, 0, pageWidth, pageHeight);
                        }
                    } else {
                        const img = new Image();
                        img.src = URL.createObjectURL(file);
                        await new Promise(r => img.onload = r);
                        const canvas = document.createElement('canvas');
                        const aspect = img.width / img.height;
                        canvas.width = 1240 * targetScale;
                        canvas.height = canvas.width / aspect;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        const imgData = canvas.toDataURL('image/jpeg', jpgQuality);
                        const imgProps = newPdf.getImageProperties(imgData);
                        const pdfWidth = newPdf.internal.pageSize.getWidth();
                        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                        newPdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
                    }
                    return newPdf.output('blob');
                };

                // LOCK LOGIC: Max 298KB
                const maxTarget = 298 * 1024; 
                
                let scale = 1.0;
                let quality = 0.8;
                let finalBlob = null;
                
                let attempts = 0;
                while (attempts < 20) {
                    finalBlob = await generatePdfBlob(scale, quality);
                    const size = finalBlob.size;

                    if (size <= maxTarget) {
                        if (size < 280 * 1024 && quality < 0.95) {
                            quality += 0.05; 
                            scale += 0.1;
                        } else {
                            break; 
                        }
                    } else {
                        if (size > 500 * 1024) {
                            quality -= 0.15; 
                            scale -= 0.2;
                        } else {
                            quality -= 0.05; 
                            scale -= 0.1;
                        }
                    }
                    
                    if (quality < 0.1) quality = 0.1;
                    if (scale < 0.4) scale = 0.4;
                    attempts++;
                }

                if (finalBlob.size > maxTarget) {
                    finalBlob = await generatePdfBlob(0.5, 0.3);
                }

                const link = document.createElement('a');
                link.href = URL.createObjectURL(finalBlob);
                link.download = `Document.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                status.innerText = `‚úÖ Success! Size: ${(finalBlob.size/1024).toFixed(2)} KB`;
                status.className = "mt-3 text-center text-xs font-mono text-green-500";

            } catch (err) {
                console.error(err);
                status.innerText = "Error: " + err.message;
                status.className = "mt-3 text-center text-xs font-mono text-red-500";
            } finally {
                spinner.classList.add('hidden');
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
